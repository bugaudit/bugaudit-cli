#!/usr/bin/env bash
DOCKER_VERSION_RESPONSE=$(docker -v)
EXPECTED_RESPONSE="Docker version "
if test "${DOCKER_VERSION_RESPONSE#*$EXPECTED_RESPONSE}" != "$DOCKER_VERSION_RESPONSE"
then
    export BUGAUDIT_HOST_WORKDIR=`pwd`
    if [ -z "$BUGAUDIT_SSH_PRIVATE_KEY" ]; then
        export BUGAUDIT_SSH_PRIVATE_KEY="$HOME/.ssh/id_rsa"
    fi
    if [[ $BUGAUDIT_CONFIG != http* ]]; then
        if [ -f "$BUGAUDIT_CONFIG" ]; then
            export BUGAUDIT_CONFIG_LOCAL_FILE="$BUGAUDIT_CONFIG"
        fi
    fi
    if [ -z "$BUGAUDIT_CONTAINER" ]; then
        export BUGAUDIT_CONTAINER="bugaudit-container"
        echo "BUGAUDIT_CONTAINER environment variable was not set."
        echo "Using default container name: $BUGAUDIT_CONTAINER"
    fi
    BUGAUDIT_CONTAINER=${BUGAUDIT_CONTAINER// /_}
    echo "Attempting to kill any running docker instances of BugAudit Runner:"
    docker kill $BUGAUDIT_CONTAINER
    echo "Attempting to remove any docker instances of BugAudit Runner:"
    docker rm $BUGAUDIT_CONTAINER
    docker pull bugaudit/bugaudit-runner
    echo "Running container: $BUGAUDIT_CONTAINER"
    BUGAUDIT_COMMAND="docker run "
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_GIT_REPO"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_GIT_BRANCH"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_SSH_KEY_PASSPHRASE"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_TRACKER_NAME"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_TRACKER_ENDPOINT"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_TRACKER_API_KEY"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_TRACKER_USERNAME"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_TRACKER_PASSWORD"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_PROJECT"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_ISSUETYPE"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_CONFIG"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_ASSIGNEE"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_SCANNER_DIR"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_TRACKER_READONLY"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_SUBSCRIBERS"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_SCANNER_CONFIG"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -e BUGAUDIT_LANG"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND --name $BUGAUDIT_CONTAINER"
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -v $BUGAUDIT_HOST_WORKDIR:/bugaudit-host-dir"
    if [ -f "$BUGAUDIT_CONFIG_LOCAL_FILE" ]; then
        BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -v $BUGAUDIT_CONFIG_LOCAL_FILE:/bugaudit-config-dir/bugaudit-config.json"
    fi
    BUGAUDIT_COMMAND="$BUGAUDIT_COMMAND -v $BUGAUDIT_SSH_PRIVATE_KEY:/bugaudit-ssh-key/ssh-priv-key bugaudit/bugaudit-runner"
    echo $BUGAUDIT_COMMAND | bash
else
    echo "Please install docker client before you begin."
fi