#!/usr/bin/env bash
DOCKER_VERSION_RESPONSE=$(docker -v)
EXPECTED_RESPONSE="Docker version "
if test "${DOCKER_VERSION_RESPONSE#*$EXPECTED_RESPONSE}" != "$DOCKER_VERSION_RESPONSE"
then
    export LOCAL_DIR_PATH=`pwd`
    if [ -z "$SSH_PRIVATE_KEY" ]; then
        export SSH_PRIVATE_KEY="$HOME/.ssh/id_rsa"
    fi
    if [[ $BUGAUDIT_CONFIG != http* ]]; then
        if [ -f "$BUGAUDIT_CONFIG" ]; then
            export BUGAUDIT_CONFIG_LOCAL_FILE="$BUGAUDIT_CONFIG"
        fi
    fi
    echo "Attempting to kill any running docker instances of BugAudit Runner:"
    docker kill bugaudit-runner
    echo "Attempting to remove any docker instances of BugAudit Runner:"
    docker rm bugaudit-runner
    docker pull bugaudit/bugaudit-runner
    docker run -ti \
    -e GIT_REPO \
    -e GIT_BRANCH \
    -e SSH_PRIVATE_KEY_FILE \
    -e SSH_PRIVATE_KEY_PASSPHRASE \
    -e BUGAUDIT_TRACKER_NAME \
    -e BUGAUDIT_TRACKER_ENDPOINT \
    -e BUGAUDIT_TRACKER_API_KEY \
    -e BUGAUDIT_TRACKER_USERNAME \
    -e BUGAUDIT_TRACKER_PASSWORD \
    -e BUGAUDIT_PROJECT \
    -e BUGAUDIT_ISSUETYPE \
    -e BUGAUDIT_CONFIG \
    -e BUGAUDIT_ASSIGNEE \
    -e BUGAUDIT_SCANNER_DIR \
    -e BUGAUDIT_TRACKER_READONLY \
    -e BUGAUDIT_SUBSCRIBERS \
    -e BUGAUDIT_SCANNER_CONFIG \
    -e BUGAUDIT_LANG \
    --name bugaudit-runner \
    -v $LOCAL_DIR_PATH:/bugaudit-host-dir \
    -v $BUGAUDIT_CONFIG_LOCAL_FILE:/bugaudit-config-dir/bugaudit-config.json \
    -v $SSH_PRIVATE_KEY:/bugaudit-ssh-key/ssh-priv-key bugaudit/bugaudit-runner
else
    echo "Please install docker client before you begin."
fi